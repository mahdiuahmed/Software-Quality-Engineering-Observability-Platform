pipeline {
    agent { label 'shopzen-agent' }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Containers') {
            steps {
                script {
                    sh 'pwd'
                    sh 'ls -la'
                    sh 'docker compose build --no-cache'
                }
            }
        }

        stage('Start Infrastructure') {
            steps {
                script {
                    // Start only the core infrastructure
                    sh 'docker compose up -d db backend frontend selenium'
                    
                    // Wait for services to be ready
                    sh '''
                        echo "Waiting for database..."
                        until docker compose exec db pg_isready -U postgres; do sleep 2; done
                        
                        echo "Waiting for backend..."
                        until curl -f http://backedn:8000 > /dev/null 2>&1; do sleep 5; done
                        
                        echo "Waiting for frontend..."
                        until curl -f http://frontend:3000 > /dev/null 2>&1; do sleep 5; done
                        
                        echo "All infrastructure services ready!"
                    '''
                }
            }
        }

        stage('Run Backend Tests') {
            steps {
                script {
                    sh 'docker compose run --rm backend-tests'
                }
            }
        }

        stage('Run Frontend Tests') {
            steps {
                script {
                    sh 'docker compose run --rm e2e-tests'
                }
            }
        }

        stage('Run Analytics') {
            steps {
                script {
                    sh 'docker compose run --rm analytics'
                }
            }
        }

        stage('Tear Down') {
            steps {
                script {
                    sh 'docker compose down'
                }
            }
        }
    }

    post {
        always {
            sh 'docker compose down'  // Ensure cleanup
        }
        success {
            echo "✅ CI pipeline completed successfully!"
        }
        failure {
            echo "❌ CI pipeline failed!"
        }
    }
}